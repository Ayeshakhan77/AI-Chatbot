{% extends "base.html" %}

{% block title %}Customer Dashboard - Chatbot Platform{% endblock %}

{% block extra_css %}
<style>
.chat-container {
    height: 70vh;
    border: 1px solid #dee2e6;
    border-radius: 0.375rem;
    overflow: hidden;
}

.chat-messages {
    height: calc(100% - 60px);
    overflow-y: auto;
    padding: 1rem;
}

.chat-input {
    height: 60px;
    border-top: 1px solid #dee2e6;
    padding: 0.5rem;
}

.message {
    margin-bottom: 1rem;
    padding: 0.75rem;
    border-radius: 0.75rem;
    max-width: 80%;
}

.user-message {
    background-color: #007bff;
    color: white;
    margin-left: auto;
}

.bot-message {
    background-color: #e9ecef;
    color: #333;
}

.agent-message {
    background-color: #28a745;
    color: white;
}

.feedback-section {
    display: none;
}
</style>
{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <h2><i class="fas fa-comments"></i> Customer Support Chat</h2>
        <p class="text-muted">Chat with our AI assistant. Your conversation may be escalated to a human agent if needed.</p>
        
        <div class="chat-container">
            <div class="chat-messages" id="chatMessages">
                <!-- Messages will be loaded here -->
            </div>
            <div class="chat-input">
                <div class="input-group">
                    <input type="text" class="form-control" id="messageInput" placeholder="Type your message...">
                    <button class="btn btn-primary" id="sendButton">
                        <i class="fas fa-paper-plane"></i> Send
                    </button>
                </div>
            </div>
        </div>

        <div class="feedback-section mt-3" id="feedbackSection">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">How was your chat experience?</h5>
                </div>
                <div class="card-body">
                    <div class="mb-3">
                        <label class="form-label">Rating (1-5 stars):</label>
                        <div class="rating-stars">
                            {% for i in range(1, 6) %}
                            <span class="star" data-rating="{{ i }}">
                                <i class="far fa-star"></i>
                            </span>
                            {% endfor %}
                        </div>
                    </div>
                    <div class="mb-3">
                        <label for="comment" class="form-label">Comments (optional):</label>
                        <textarea class="form-control" id="comment" rows="3"></textarea>
                    </div>
                    <button class="btn btn-success" id="submitFeedback">
                        <i class="fas fa-check"></i> Submit Feedback
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
const sessionId = "{{ session_id }}";
let selectedRating = 0;

// Load chat history
function loadChatHistory() {
    $.get(`/customer/api/chat_history?session_id=${sessionId}`, function(messages) {
        const chatMessages = $('#chatMessages');
        chatMessages.empty();
        
        messages.forEach(msg => {
            const messageClass = msg.type === 'user' ? 'user-message' : 
                               msg.type === 'agent' ? 'agent-message' : 'bot-message';
            const messageHtml = `
                <div class="message ${messageClass}">
                    <div class="message-content">${msg.content}</div>
                    <small class="message-time">${new Date(msg.timestamp).toLocaleTimeString()}</small>
                </div>
            `;
            chatMessages.append(messageHtml);
        });
        
        chatMessages.scrollTop(chatMessages[0].scrollHeight);
    });
}

// Send message
function sendMessage() {
    const message = $('#messageInput').val().trim();
    if (!message) return;
    
    $('#messageInput').val('');
    
    // Add user message immediately
    const chatMessages = $('#chatMessages');
    const userMessageHtml = `
        <div class="message user-message">
            <div class="message-content">${message}</div>
            <small class="message-time">${new Date().toLocaleTimeString()}</small>
        </div>
    `;
    chatMessages.append(userMessageHtml);
    chatMessages.scrollTop(chatMessages[0].scrollHeight);
    
    // Send to server
    $.post('/customer/api/send_message', {
        session_id: sessionId,
        message: message
    }, function(response) {
        if (response.error) {
            alert('Error: ' + response.error);
            return;
        }
        
        // Add bot response
        const botMessageHtml = `
            <div class="message bot-message">
                <div class="message-content">${response.bot_response}</div>
                <small class="message-time">${new Date().toLocaleTimeString()}</small>
            </div>
        `;
        chatMessages.append(botMessageHtml);
        chatMessages.scrollTop(chatMessages[0].scrollHeight);
        
        // Show feedback if session is closed
        if (response.session_status === 'closed') {
            $('#feedbackSection').show();
        }
    }).fail(function() {
        alert('Failed to send message. Please try again.');
    });
}

// Initialize rating stars
$('.star').on('click', function() {
    const rating = $(this).data('rating');
    selectedRating = rating;
    
    $('.star').each(function() {
        const starRating = $(this).data('rating');
        if (starRating <= rating) {
            $(this).html('<i class="fas fa-star"></i>');
        } else {
            $(this).html('<i class="far fa-star"></i>');
        }
    });
});

// Submit feedback
$('#submitFeedback').on('click', function() {
    if (selectedRating === 0) {
        alert('Please select a rating');
        return;
    }
    
    $.post('/customer/api/submit_feedback', {
        session_id: sessionId,
        rating: selectedRating,
        comment: $('#comment').val()
    }, function(response) {
        if (response.success) {
            alert('Thank you for your feedback!');
            $('#feedbackSection').hide();
        } else {
            alert('Error submitting feedback');
        }
    });
});

// Event listeners
$(document).ready(function() {
    loadChatHistory();
    
    $('#sendButton').on('click', sendMessage);
    
    $('#messageInput').on('keypress', function(e) {
        if (e.which === 13) { // Enter key
            sendMessage();
        }
    });
    
    // Poll for new messages
    setInterval(loadChatHistory, 3000);
});
</script>
{% endblock %}